{"version":3,"file":"deploy.js","sourceRoot":"","sources":["../../../src/cli/services/deploy.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable require-atomic-updates */\nimport {\n  UploadExtensionValidationError,\n  uploadFunctionExtensions,\n  uploadThemeExtensions,\n  uploadExtensionsBundle,\n} from './deploy/upload.js'\n\nimport {ensureDeployContext} from './context.js'\nimport {bundleAndBuildExtensions} from './deploy/bundle.js'\nimport {fetchAppExtensionRegistrations} from './dev/fetch.js'\nimport {AppInterface} from '../models/app/app.js'\nimport {Identifiers, updateAppIdentifiers} from '../models/app/identifiers.js'\nimport {OrganizationApp} from '../models/organization.js'\nimport {AllAppExtensionRegistrationsQuerySchema} from '../api/graphql/all_app_extension_registrations.js'\nimport {ExtensionInstance} from '../models/extensions/extension-instance.js'\nimport {FunctionConfigType} from '../models/extensions/specifications/function.js'\nimport {renderInfo, renderSuccess, renderTasks} from '@shopify/cli-kit/node/ui'\nimport {inTemporaryDirectory, mkdir} from '@shopify/cli-kit/node/fs'\nimport {joinPath, dirname} from '@shopify/cli-kit/node/path'\nimport {outputNewline, outputInfo, formatPackageManagerCommand} from '@shopify/cli-kit/node/output'\nimport {useThemebundling} from '@shopify/cli-kit/node/context/local'\nimport {getArrayRejectingUndefined} from '@shopify/cli-kit/common/array'\nimport type {AlertCustomSection, Task} from '@shopify/cli-kit/node/ui'\n\ninterface DeployOptions {\n  /** The app to be built and uploaded */\n  app: AppInterface\n\n  /** API key of the app in Partners admin */\n  apiKey?: string\n\n  /** If true, ignore any cached appId or extensionId */\n  reset: boolean\n\n  /** If true, proceed with deploy without asking for confirmation */\n  force: boolean\n}\n\ninterface TasksContext {\n  bundlePath?: string\n  bundle?: boolean\n}\n\nexport async function deploy(options: DeployOptions) {\n  renderInfo({\n    headline: [\n      'Stay tuned for changes to',\n      {command: formatPackageManagerCommand(options.app.packageManager, 'deploy')},\n      {char: '.'},\n    ],\n    body: \"Soon, you'll be able to release all your extensions at the same time, directly from Shopify CLI.\",\n    reference: [\n      {\n        link: {\n          url: 'https://shopify.dev/docs/apps/deployment/simplified-deployment',\n          label: 'Simplified extension deployment',\n        },\n      },\n    ],\n  })\n\n  // eslint-disable-next-line prefer-const\n  let {app, identifiers, partnersApp, token} = await ensureDeployContext(options)\n  const apiKey = identifiers.app\n\n  if (!options.app.hasExtensions() && !partnersApp.betas?.unifiedAppDeployment) {\n    renderInfo({headline: 'No extensions to deploy to Shopify Partners yet.'})\n    return\n  }\n\n  outputNewline()\n  outputInfo(`Deploying your work to Shopify Partners. It will be part of ${partnersApp.title}`)\n  outputNewline()\n\n  let registrations: AllAppExtensionRegistrationsQuerySchema\n  let validationErrors: UploadExtensionValidationError[] = []\n  let deploymentId: number\n  const unifiedDeployment = partnersApp.betas?.unifiedAppDeployment ?? false\n\n  await inTemporaryDirectory(async (tmpDir) => {\n    try {\n      const bundle = app.allExtensions.some((ext) => ext.features.includes('bundling'))\n      let bundlePath: string | undefined\n\n      if (bundle) {\n        bundlePath = joinPath(tmpDir, `bundle.zip`)\n        await mkdir(dirname(bundlePath))\n      }\n      await bundleAndBuildExtensions({app, bundlePath, identifiers})\n      const tasks: Task<TasksContext>[] = [\n        {\n          title: 'Running validation',\n          task: async () => {\n            await Promise.all([app.allExtensions.map((ext) => ext.preDeployValidation())])\n          },\n        },\n        {\n          title: unifiedDeployment ? 'Creating deployment' : 'Pushing your code to Shopify',\n          task: async () => {\n            const extensions = await Promise.all(\n              options.app.allExtensions.flatMap((ext) =>\n                ext.bundleConfig({identifiers, token, apiKey, unifiedDeployment}),\n              ),\n            )\n\n            if (bundle || unifiedDeployment) {\n              ;({validationErrors, deploymentId} = await uploadExtensionsBundle({\n                apiKey,\n                bundlePath,\n                extensions: getArrayRejectingUndefined(extensions),\n                token,\n                extensionIds: identifiers.extensionIds,\n              }))\n            }\n\n            if (!useThemebundling()) {\n              const themeExtensions = options.app.allExtensions.filter((ext) => ext.isThemeExtension)\n              await uploadThemeExtensions(themeExtensions, {apiKey, identifiers, token})\n            }\n\n            if (!unifiedDeployment) {\n              const functions = options.app.allExtensions.filter(\n                (ext) => ext.isFunctionExtension,\n              ) as ExtensionInstance<FunctionConfigType>[]\n              identifiers = await uploadFunctionExtensions(functions, {\n                identifiers,\n                token,\n              })\n            }\n\n            app = await updateAppIdentifiers({app, identifiers, command: 'deploy'})\n            registrations = await fetchAppExtensionRegistrations({token, apiKey: identifiers.app})\n          },\n        },\n      ]\n\n      await renderTasks(tasks)\n\n      await outputCompletionMessage({\n        app,\n        partnersApp,\n        partnersOrganizationId: partnersApp.organizationId,\n        identifiers,\n        registrations,\n        validationErrors,\n        deploymentId,\n        unifiedDeployment,\n      })\n\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    } catch (error: any) {\n      /**\n       * If deployment fails when uploading we want the identifiers to be persisted\n       * for the next run.\n       */\n      await updateAppIdentifiers({app, identifiers, command: 'deploy'})\n      throw error\n    }\n  })\n}\n\nasync function outputCompletionMessage({\n  app,\n  partnersApp,\n  partnersOrganizationId,\n  identifiers,\n  registrations,\n  validationErrors,\n  deploymentId,\n  unifiedDeployment,\n}: {\n  app: AppInterface\n  partnersApp: Omit<OrganizationApp, 'apiSecretKeys' | 'apiKey'>\n  partnersOrganizationId: string\n  identifiers: Identifiers\n  registrations: AllAppExtensionRegistrationsQuerySchema\n  validationErrors: UploadExtensionValidationError[]\n  deploymentId: number\n  unifiedDeployment: boolean\n}) {\n  if (unifiedDeployment) {\n    return renderSuccess({\n      headline: 'Deployment created.',\n      body: {\n        link: {\n          url: `https://partners.shopify.com/${partnersOrganizationId}/apps/${partnersApp.id}/deployments/${deploymentId}`,\n          label: `Deployment ${deploymentId}`,\n        },\n      },\n      nextSteps: ['Publish your deployment to make your changes go live for merchants'],\n    })\n  }\n\n  let headline: string\n\n  if (validationErrors.length > 0) {\n    headline = 'Deployed to Shopify, but fixes are needed.'\n  } else {\n    headline = 'Deployed to Shopify!'\n  }\n\n  const outputDeployedButNotLiveMessage = (extension: ExtensionInstance) => {\n    const result = [`${extension.localIdentifier} is deployed to Shopify but not yet live`]\n    const uuid = identifiers.extensions[extension.localIdentifier]\n    const validationError = validationErrors.find((error) => error.uuid === uuid)\n\n    if (validationError) {\n      result.push('\\n- Validation errors found in your extension toml file')\n      validationError.errors.forEach((err) => {\n        result.push(`\\n  └ ${err.message}`)\n      })\n    }\n\n    return result\n  }\n\n  const outputDeployedAndLiveMessage = (extension: ExtensionInstance) => {\n    return `${extension.localIdentifier} is live`\n  }\n\n  const outputNextStep = async (extension: ExtensionInstance) => {\n    const extensionId =\n      registrations.app.extensionRegistrations.find((registration) => {\n        return registration.uuid === identifiers.extensions[extension.localIdentifier]\n      })?.id ?? ''\n    return [\n      'Publish',\n      {\n        link: {\n          url: await extension.publishURL({orgId: partnersOrganizationId, appId: partnersApp.id, extensionId}),\n          label: extension.localIdentifier,\n        },\n      },\n    ]\n  }\n\n  const nonFunctionExtensions = app.allExtensions.filter((ext) => !ext.isFunctionExtension)\n  const functionExtensions = app.allExtensions.filter((ext) => ext.isFunctionExtension)\n\n  const customSections: AlertCustomSection[] = [\n    {\n      title: 'Summary',\n      body: {\n        list: {\n          items: [\n            ...nonFunctionExtensions.map(outputDeployedButNotLiveMessage),\n            ...functionExtensions.map(outputDeployedAndLiveMessage),\n          ],\n        },\n      },\n    },\n  ]\n\n  if (nonFunctionExtensions.length > 0) {\n    customSections.push({\n      title: 'Next steps',\n      body: {\n        list: {\n          items: await Promise.all(nonFunctionExtensions.map(outputNextStep)),\n        },\n      },\n    })\n  }\n\n  renderSuccess({\n    headline,\n    customSections,\n  })\n}\n"]}